
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>我的玩具——乐高魔方机器人 - xelz's blog</title>
	<meta name="author" content="xelz">

	
	<meta name="description" content="视频预览 优酷视频: Youtube: 0x00 简要说明 硬件环境：Lego NXT 8547, iPhone 4S(需越狱) 软件依赖：LeJOS, BTStack, OpenCV2 还原效率：扫描10~15秒，计算&lt;1秒，还原~1分钟 Github：iOS控制器 Lego机器人 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="xelz's blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="/javascripts/jquery.min.js"></script>
    
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">xelz's blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:xelz.info">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
		<a class="github" href="https://github.com/xelzmm" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:xelz.info">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">我的玩具——乐高魔方机器人</h2>
	<div class="entry-content"><p>视频预览</p>

<p>优酷视频:</p>

<iframe height=490 width='100%' src='http://player.youku.com/embed/XMjUyMDcxMDk1Mg==' frameborder=0 'allowfullscreen'></iframe>


<p>Youtube:</p>

<iframe width="100%" height="450" src="https://www.youtube.com/embed/lXMsFn_69Dw" frameborder="0" allowfullscreen></iframe>


<h2>0x00 简要说明</h2>

<p><strong>硬件环境</strong>：Lego NXT 8547, iPhone 4S(需越狱)</p>

<p><strong>软件依赖</strong>：LeJOS, BTStack, OpenCV2</p>

<p><strong>还原效率</strong>：扫描10~15秒，计算&lt;1秒，还原~1分钟</p>

<p><strong>Github</strong>：<a href="https://github.com/xelzmm/ios-lego-cube-solver">iOS控制器</a>  <a href="https://github.com/xelzmm/lego-cube-solver">Lego机器人</a></p>

<!-- more -->


<h2>0x01 Lego &amp; Tilted Twister</h2>

<p>5年前心血来潮，为了做一个能自动拧魔方的机器人，买了一套乐高8547，按当时的收入算，简直是花了一笔巨款(默默心疼3秒)，之后就开始各种折腾。折腾了两天实在受不了那个中看不中用的GUI编程套件，直接刷了<a href="http://www.lejos.org">LeJOS</a>(Lego Java OS)，它提供了Java Runtime，可以愉快地使用Java进行coding。</p>

<p><img src="/assets/2017/lego-8547.jpg" alt="lego-8547" /></p>

<p>先是抱Hans Andersson大神的大腿，开始拼<a href="http://tiltedtwister.com/download/tt2/TT2.pdf">Tilted Twister</a>，拼成之后发现完全无法顺利行╮(╯▽╰)╭。主要原因是颜色识别很不准，主要是魔方的<strong>橙色</strong>块和<strong>红色</strong>块，通过颜色传感器采集到的颜色值太相近了(采集到的颜色值是8bit，范围是0~255)，根本无法有效区分开，外界光线的亮一点或者暗一点都会严重影响识别正确率。并且因为乐高自身的CPU和内存都弱到爆炸，大约需要30s~60s才能计算出一个平均50步的解法，再花约3-5分钟进行还原，速度还没有我自己快。</p>

<p><img src="/assets/2017/tiltedtwister2.jpg" alt="lego-8547" /></p>

<p>后来冒出了个想法：何不使用手机摄像头扫描，然后在手机上计算还原步骤再控制机器人还原？这样不仅可以一次性扫描9个色块，也可以利用手机强大的CPU在更短的时间内计算出步骤更少的解法，同时提高准确率与运行效率。</p>

<h2>0x02 动手改造</h2>

<p>先把颜色传感器拆掉，原来的LEGO的执行程序就不能用了，需要自己来写，只需实现机械控制部分。</p>

<p>机器人有两个Motor，以LEGO的前脸为正面视角：</p>

<p><img src="/assets/2017/lego-axis.png" alt="axis" /></p>

<ul>
<li>机械臂往前<code>推(PUSH)</code>，可以让魔方绕X轴逆时针旋转90°，实现上、前、下、后四个面之间的翻转</li>
<li>底座<code>旋转(ROTATE)</code>，可以让魔方绕Y轴旋转，实现前，右，后，左四个面之间的翻转</li>
<li>机械臂和底座配合，可以将魔方翻转到任意面</li>
<li>机械臂<code>抓住(HOLD)</code>魔方的上面两层，然后底座旋转，可以实现<code>拧(TWIST)</code>魔方的底面</li>
<li>公式的每一步操作都可以拆解为：将该步骤所要拧的面翻转到底面，然后抓住魔方，用底座拧魔方的底面</li>
</ul>


<p>(PS: 魔方公式形如<code>U2 F D' R2 D F2 B2 L2</code>,每个字母代表顺时针将一个面旋转90°：Up, Bottom, Front, Back, Left, Right. 字母后面跟<code>2</code>表示拧两次，也就是180°，跟<code>'</code>表示逆时针90°。)</p>

<p>因此，需要两个循环队列来保存魔方在X轴和Y轴方向上的状态：pushChain的第一个元素是朝下的面，第二个元素就是通过一次PUSH操作，会翻转到朝下的面，也就是朝前的面，以此类推。每次旋转或者翻转操作，都需要同步更新两个队列的状态</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span>   <span class="n">pushChain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(),</span>
</span><span class='line'>                                  <span class="n">rotateChain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">static</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">pushChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">D</span><span class="o">);</span>
</span><span class='line'>    <span class="n">pushChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">F</span><span class="o">);</span>
</span><span class='line'>    <span class="n">pushChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">U</span><span class="o">);</span>
</span><span class='line'>    <span class="n">pushChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">B</span><span class="o">);</span>
</span><span class='line'>    <span class="n">rotateChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">F</span><span class="o">);</span>
</span><span class='line'>    <span class="n">rotateChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">L</span><span class="o">);</span>
</span><span class='line'>    <span class="n">rotateChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">B</span><span class="o">);</span>
</span><span class='line'>    <span class="n">rotateChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">R</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * push the cube using the long arm.</span>
</span><span class='line'><span class="cm"> * Face FRONT turns to DOWN</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">arm</span><span class="o">.</span><span class="na">rotate</span><span class="o">(</span><span class="n">PUSH_ANGLE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
</span><span class='line'>    <span class="n">arm</span><span class="o">.</span><span class="na">rotate</span><span class="o">(-</span><span class="n">PUSH_ANGLE</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// update pushChain and rotateChain</span>
</span><span class='line'>    <span class="n">pushChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pushChain</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
</span><span class='line'>    <span class="n">rotateChain</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">pushChain</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
</span><span class='line'>    <span class="n">rotateChain</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">pushChain</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * rotate the base (DOWN FACE) with a specified angle</span>
</span><span class='line'><span class="cm"> * @param angle the degrees to rotate</span>
</span><span class='line'><span class="cm"> * @param changeFacelet whether to update the facelet chain</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">rotate</span><span class="o">(</span><span class="kt">int</span> <span class="n">angle</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">changeFacelet</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">currentPosition</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="na">getTachoCount</span><span class="o">();</span>
</span><span class='line'>    <span class="k">switch</span> <span class="o">(</span><span class="n">angle</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">90</span><span class="o">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">currentPosition</span> <span class="o">&gt;</span> <span class="mi">225</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">base</span><span class="o">.</span><span class="na">rotateTo</span><span class="o">(</span><span class="n">currentPosition</span> <span class="o">-</span> <span class="mi">270</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">base</span><span class="o">.</span><span class="na">rotateTo</span><span class="o">(</span><span class="n">currentPosition</span> <span class="o">+</span> <span class="mi">90</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">changeFacelet</span><span class="o">)</span>
</span><span class='line'>                <span class="n">rotateChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rotateChain</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
</span><span class='line'>            <span class="k">break</span><span class="o">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">180</span><span class="o">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">currentPosition</span> <span class="o">&gt;</span> <span class="mi">135</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">base</span><span class="o">.</span><span class="na">rotateTo</span><span class="o">(</span><span class="n">currentPosition</span> <span class="o">-</span> <span class="mi">180</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">base</span><span class="o">.</span><span class="na">rotateTo</span><span class="o">(</span><span class="n">currentPosition</span> <span class="o">+</span> <span class="mi">180</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">changeFacelet</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">rotateChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rotateChain</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
</span><span class='line'>                <span class="n">rotateChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rotateChain</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">break</span><span class="o">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="o">-</span><span class="mi">90</span><span class="o">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">currentPosition</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">base</span><span class="o">.</span><span class="na">rotateTo</span><span class="o">(</span><span class="n">currentPosition</span> <span class="o">+</span> <span class="mi">270</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">base</span><span class="o">.</span><span class="na">rotateTo</span><span class="o">(</span><span class="n">currentPosition</span> <span class="o">-</span> <span class="mi">90</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">changeFacelet</span><span class="o">)</span>
</span><span class='line'>                <span class="n">rotateChain</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">rotateChain</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
</span><span class='line'>            <span class="k">break</span><span class="o">;</span>
</span><span class='line'>        <span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">changeFacelet</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">pushChain</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">rotateChain</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
</span><span class='line'>        <span class="n">pushChain</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">rotateChain</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>之后就可以将任意面，通过不超过两步的操作翻转到底面，例如，可以通过两次<code>PUSH</code>将顶面翻转到底面，也可以通过底座顺时针旋转90°后，再<code>PUSH</code>将左侧的面翻转到底面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * make the specified facelet downwards to bottom</span>
</span><span class='line'><span class="cm"> * @param facelet target face</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">changetoFacelet</span><span class="o">(</span><span class="n">String</span> <span class="n">facelet</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">switch</span> <span class="o">(</span><span class="n">pushChain</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">facelet</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>            <span class="n">push</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>            <span class="n">push</span><span class="o">();</span>
</span><span class='line'>            <span class="n">push</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>            <span class="n">rotate</span><span class="o">(</span><span class="mi">180</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>            <span class="n">push</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">switch</span> <span class="o">(</span><span class="n">rotateChain</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">facelet</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>            <span class="n">rotate</span><span class="o">(</span><span class="mi">90</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>            <span class="n">push</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>            <span class="n">rotate</span><span class="o">(-</span><span class="mi">90</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>            <span class="n">push</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>拧(TWIST)</code>的动作可以通过<code>HOLD-&gt;ROTATE-&gt;RELEASE</code>的步骤实现</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * twist DOWN FACE 90 degrees</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">turnClockwise</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">hold</span><span class="o">();</span>
</span><span class='line'>    <span class="n">rotate</span><span class="o">(</span><span class="mi">90</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="n">release</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * twist DOWN FACE -90 degrees</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">turnAntiClockwise</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">hold</span><span class="o">();</span>
</span><span class='line'>    <span class="n">rotate</span><span class="o">(-</span><span class="mi">90</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="n">release</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * twist DOWN FACE 180 degrees</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">turnSemiCycle</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">hold</span><span class="o">();</span>
</span><span class='line'>    <span class="n">rotate</span><span class="o">(</span><span class="mi">180</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="n">release</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>至此，输入公式，机器人就可以一步步操作了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Execute a specified expression</span>
</span><span class='line'><span class="cm"> * @param exp the expression to be executed</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">static</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">exp</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">exp</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changetoFacelet</span><span class="o">(</span><span class="n">exp</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">exp</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">exp</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">turnClockwise</span><span class="o">();</span>
</span><span class='line'>            <span class="n">i</span><span class="o">++;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">exp</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">turnAntiClockwise</span><span class="o">();</span>
</span><span class='line'>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">exp</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">turnSemiCycle</span><span class="o">();</span>
</span><span class='line'>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面的视频是当时留下的一个DEMO，事先向LEGO输入了20步的还原公式，LEGO只管按照公式拧：</p>

<iframe height=490 width='100%' src='http://player.youku.com/embed/XMzc0MTgzNDEy' frameborder=0 'allowfullscreen'></iframe>


<h2>0x03 加入Android控制器</h2>

<p>LEGO支持蓝牙通信，因此可以用手机做主控端，整个系统的构思如下：</p>

<ul>
<li>手机与LEGO通过蓝牙连接</li>
<li>LEGO检测到魔方放入之后通知手机开始扫描</li>
<li>手机扫描完一个面之后，通知LEGO将魔方翻转到下一个面</li>
<li>扫描完毕后，手机开始计算还原步骤</li>
<li>手机通过蓝牙将还原公式发送给LEGO</li>
<li>LEGO按照公式将魔方还原</li>
</ul>


<p>手里有个Android手机(KTouch-650)，还有一部iPod Touch 4，虽然Android机性能有点差，但我那时候完全不懂Android和iOS开发。好在Java技能是游刃有余的，Android开发可以快速上手，也就不得不选择Android了。蓝牙连接和还原算法都好办，虽然LeJOS官方没有提供Android与LEGO通信的SDK，但是完全可以仿照PC的SDK实现一套，将蓝牙相关的实现替换为android.bluetooth包提供的实现即可。网上已经有大神给出了<a href="https://github.com/jpralves/tourrobot/blob/master/NXTController/src/lejos/pc/comm/NXTCommAndroid.java">源码</a>。还原算法可以直接采用Java实现的Two-Phase算法<a href="http://kociemba.org/cube.htm">twophase.jar</a>。</p>

<p>那么问题来了，怎么检测魔方在摄像头采集的画面中的位置，或者说怎么确定采集哪些像素点的颜色？最笨的办法就是——固定位置，为此，在取景界面上绘制了一个9宫格作为参考线，方便手动对齐：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDraw</span><span class="o">(</span><span class="n">Canvas</span> <span class="n">canvas</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>
</span><span class='line'>  <span class="n">Paint</span> <span class="n">paint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Paint</span><span class="o">();</span>
</span><span class='line'>  <span class="n">paint</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">WHITE</span><span class="o">);</span>
</span><span class='line'>  <span class="n">paint</span><span class="o">.</span><span class="na">setStyle</span><span class="o">(</span><span class="n">Style</span><span class="o">.</span><span class="na">STROKE</span><span class="o">);</span>
</span><span class='line'>  <span class="n">canvas</span><span class="o">.</span><span class="na">drawRect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">paint</span><span class="o">);</span>
</span><span class='line'>  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">canvas</span><span class="o">.</span><span class="na">drawLine</span><span class="o">(</span><span class="n">width</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">width</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">,</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span><span class="n">paint</span><span class="o">);</span>
</span><span class='line'>      <span class="n">canvas</span><span class="o">.</span><span class="na">drawLine</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">,</span> <span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>大概长成这个样子：</p>

<p><img src="/assets/2017/grid.png" alt="grid" /></p>

<p>手动将魔方与九宫格参考线对齐之后，点击屏幕任意位置开始取色。取色的时候需要取中心区域的多个点，然后计算平均色值，避免单个点的色值误差太大。这里遇到一个问题是Android摄像头的预览图像数据是YUV色彩空间，而不是RGB，需要先进行一次转换:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPreviewFrame</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="n">Camera</span> <span class="n">camera</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span><span class="o">(!</span><span class="n">flag</span><span class="o">)</span><span class="k">return</span><span class="o">;</span>
</span><span class='line'>  <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>  <span class="n">Parameters</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">getPreviewSize</span><span class="o">().</span><span class="na">width</span><span class="o">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">getPreviewSize</span><span class="o">().</span><span class="na">height</span><span class="o">;</span>
</span><span class='line'>  <span class="kt">int</span><span class="o">[]</span> <span class="n">rgbBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">height</span><span class="o">*</span><span class="n">width</span><span class="o">];</span>
</span><span class='line'>  <span class="n">decodeYUV420SP</span><span class="o">(</span><span class="n">rgbBuf</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">);</span>
</span><span class='line'>  <span class="n">Bitmap</span> <span class="n">bitmap</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">rgbBuf</span><span class="o">,</span> <span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">Config</span><span class="o">.</span><span class="na">RGB_565</span><span class="o">);</span>
</span><span class='line'>  <span class="n">pickupColors</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span><span class="o">(!</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="n">faceletNum</span> <span class="o">!=</span> <span class="mi">6</span><span class="o">)</span>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>      <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">decodeYUV420SP</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">rgbBuf</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">yuv420sp</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">final</span> <span class="kt">int</span> <span class="n">frameSize</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="o">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">rgbBuf</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">&quot;buffer &#39;rgbBuf&#39; is null&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">rgbBuf</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">frameSize</span><span class="o">)</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;buffer &#39;rgbBuf&#39; size &quot;</span>
</span><span class='line'>              <span class="o">+</span> <span class="n">rgbBuf</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="s">&quot; &lt; minimum &quot;</span> <span class="o">+</span> <span class="n">frameSize</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">yuv420sp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">&quot;buffer &#39;yuv420sp&#39; is null&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">yuv420sp</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">frameSize</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;buffer &#39;yuv420sp&#39; size &quot;</span>
</span><span class='line'>              <span class="o">+</span> <span class="n">yuv420sp</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="s">&quot; &lt; minimum &quot;</span> <span class="o">+</span> <span class="n">frameSize</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="o">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">yp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">height</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">uvp</span> <span class="o">=</span> <span class="n">frameSize</span> <span class="o">+</span> <span class="o">(</span><span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">*</span> <span class="n">width</span><span class="o">,</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">width</span><span class="o">;</span> <span class="n">i</span><span class="o">++,</span> <span class="n">yp</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="o">(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">yuv420sp</span><span class="o">[</span><span class="n">yp</span><span class="o">]))</span> <span class="o">-</span> <span class="mi">16</span><span class="o">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>              <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">yuv420sp</span><span class="o">[</span><span class="n">uvp</span><span class="o">++])</span> <span class="o">-</span> <span class="mi">128</span><span class="o">;</span>
</span><span class='line'>              <span class="n">u</span> <span class="o">=</span> <span class="o">(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">yuv420sp</span><span class="o">[</span><span class="n">uvp</span><span class="o">++])</span> <span class="o">-</span> <span class="mi">128</span><span class="o">;</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">y1192</span> <span class="o">=</span> <span class="mi">1192</span> <span class="o">*</span> <span class="n">y</span><span class="o">;</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">y1192</span> <span class="o">+</span> <span class="mi">1634</span> <span class="o">*</span> <span class="n">v</span><span class="o">);</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">g</span> <span class="o">=</span> <span class="o">(</span><span class="n">y1192</span> <span class="o">-</span> <span class="mi">833</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">400</span> <span class="o">*</span> <span class="n">u</span><span class="o">);</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="o">(</span><span class="n">y1192</span> <span class="o">+</span> <span class="mi">2066</span> <span class="o">*</span> <span class="n">u</span><span class="o">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>              <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>          <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">262143</span><span class="o">)</span>
</span><span class='line'>              <span class="n">r</span> <span class="o">=</span> <span class="mi">262143</span><span class="o">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>              <span class="n">g</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>          <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">&gt;</span> <span class="mi">262143</span><span class="o">)</span>
</span><span class='line'>              <span class="n">g</span> <span class="o">=</span> <span class="mi">262143</span><span class="o">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>              <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>          <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">262143</span><span class="o">)</span>
</span><span class='line'>              <span class="n">b</span> <span class="o">=</span> <span class="mi">262143</span><span class="o">;</span>
</span><span class='line'>          <span class="n">rgbBuf</span><span class="o">[</span><span class="n">yp</span><span class="o">]</span> <span class="o">=</span> <span class="mh">0xff000000</span> <span class="o">|</span> <span class="o">((</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="o">)</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="o">)</span>
</span><span class='line'>                  <span class="o">|</span> <span class="o">((</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="o">)</span> <span class="o">|</span> <span class="o">((</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>转换到RGB就可以正常取色，取色完毕之后就需要根据颜色来计算魔方的状态了，然后转换为U、B、D、F、R、L的形式表示。我采取的算法比较简单，先确定每个面中心块的颜色，做为该面的颜色(因为魔方不管怎么转，一个面的中心块，是不会跑到其他面的)，然后拿每个块的颜色分别与六个中间块的颜色对比，计算在RGB分量上的差值，差值最小的中心块的颜色，就是当前色块的颜色，也就是说这个块还原后和这个中心块在同一个面。差值计算方式采用RGB分量的差平方之和，代码节选如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">solveColors</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">centerColors</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">6</span><span class="o">];</span>
</span><span class='line'>  <span class="kt">char</span><span class="o">[]</span> <span class="n">facelets</span> <span class="o">=</span> <span class="o">{</span><span class="sc">&#39;U&#39;</span><span class="o">,</span><span class="sc">&#39;B&#39;</span><span class="o">,</span><span class="sc">&#39;D&#39;</span><span class="o">,</span><span class="sc">&#39;F&#39;</span><span class="o">,</span><span class="sc">&#39;R&#39;</span><span class="o">,</span><span class="sc">&#39;L&#39;</span><span class="o">};</span>
</span><span class='line'>  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">centerColors</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">cubeColors</span><span class="o">[</span><span class="n">i</span><span class="o">*</span><span class="mi">9</span><span class="o">+</span><span class="mi">4</span><span class="o">];</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">centerColors</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;color&quot;</span><span class="o">,</span><span class="s">&quot;center color: &quot;</span> <span class="o">+</span> <span class="n">facelets</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">Color</span><span class="o">.</span><span class="na">red</span><span class="o">(</span><span class="n">color</span><span class="o">)+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Color</span><span class="o">.</span><span class="na">green</span><span class="o">(</span><span class="n">color</span><span class="o">)+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Color</span><span class="o">.</span><span class="na">blue</span><span class="o">(</span><span class="n">color</span><span class="o">));</span>           
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">54</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">cubeR</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">red</span><span class="o">(</span><span class="n">cubeColors</span><span class="o">[</span><span class="n">i</span><span class="o">]),</span>
</span><span class='line'>          <span class="n">cubeG</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">green</span><span class="o">(</span><span class="n">cubeColors</span><span class="o">[</span><span class="n">i</span><span class="o">]),</span>
</span><span class='line'>          <span class="n">cubeB</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">blue</span><span class="o">(</span><span class="n">cubeColors</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;color&quot;</span><span class="o">,</span><span class="s">&quot;cube color: &quot;</span> <span class="o">+</span> <span class="n">cubeR</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">cubeG</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">cubeB</span><span class="o">);</span>           
</span><span class='line'>      <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">6</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">centerR</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">red</span><span class="o">(</span><span class="n">centerColors</span><span class="o">[</span><span class="n">j</span><span class="o">]),</span>
</span><span class='line'>              <span class="n">centerG</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">green</span><span class="o">(</span><span class="n">centerColors</span><span class="o">[</span><span class="n">j</span><span class="o">]),</span>
</span><span class='line'>              <span class="n">centerB</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="na">blue</span><span class="o">(</span><span class="n">centerColors</span><span class="o">[</span><span class="n">j</span><span class="o">]);</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="o">(</span><span class="n">cubeR</span> <span class="o">-</span> <span class="n">centerR</span><span class="o">)</span> <span class="o">*</span> <span class="o">(</span><span class="n">cubeR</span> <span class="o">-</span> <span class="n">centerR</span><span class="o">)</span>
</span><span class='line'>                  <span class="o">+</span> <span class="o">(</span><span class="n">cubeG</span> <span class="o">-</span> <span class="n">centerG</span><span class="o">)</span> <span class="o">*</span> <span class="o">(</span><span class="n">cubeG</span> <span class="o">-</span> <span class="n">centerG</span><span class="o">)</span>
</span><span class='line'>                  <span class="o">+</span> <span class="o">(</span><span class="n">cubeB</span> <span class="o">-</span> <span class="n">centerB</span><span class="o">)</span> <span class="o">*</span> <span class="o">(</span><span class="n">cubeB</span> <span class="o">-</span> <span class="n">centerB</span><span class="o">);</span>
</span><span class='line'>          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;color&quot;</span><span class="o">,</span><span class="s">&quot;s for &quot;</span> <span class="o">+</span> <span class="n">facelets</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
</span><span class='line'>          <span class="k">if</span><span class="o">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">min</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">min</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
</span><span class='line'>              <span class="n">cubefaces</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">facelets</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;color&quot;</span><span class="o">,</span><span class="s">&quot;face: &quot;</span><span class="o">+</span><span class="n">cubefaces</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然而，实际测试下来发现，这样的算法经常会有计算错误的时候，光线比较暗的情况下，摄像头取到的24bit的橙色和红色，依然很接近，用肉眼都很难区分。</p>

<p>还有另外一个坑，采用twophase.jar这个lib，需要约30~60M的内存，用于构建搜索树，这在当时的Android机上(至少在我的破手机上)，是不可能的事情，只好作罢，方案不得不改成：</p>

<ol>
<li>Android连接LEGO并手动扫描魔方状态</li>
<li>电脑上起一个Servlet，用于跑还原算法，按照i5的性能，平均1~2秒即可计算出22步以内的结果。</li>
<li>Android通过HTTP调用电脑的计算接口，把魔方状态作为参数，获取还原公式</li>
<li>将还原公式发给LEGO，由LEGO还原魔方</li>
</ol>


<p><img src="/assets/2017/woqu.png" alt="woqu" /></p>

<p>如此繁琐，颜色识别的准确率又不美丽，我不禁开始思考人生。。。</p>

<p><img src="/assets/2017/thinking.png" alt="thinking" /></p>

<p>期间考虑过换用iOS设备，但是iOS设备的蓝牙不支持RFCOMM通讯协议，也就作罢。</p>

<p>结果是，机器人被供了起来，5年里，跟着我搬了4次家。。。</p>

<h2>0x04 在iOS上重构控制器</h2>

<p>后来慢慢接触到了iOS越狱开发，也知道了BTStack这个开源库，可以通过直接操作底层接口，让越狱的iOS设备实现RFCOMM等官方蓝牙SDK不支持的协议。看了一眼躺在书橱里吃灰的LEGO机器人，想着是时候拿出来晒晒太阳了 ^.^</p>

<h3>蓝牙部分</h3>

<p>先clone了BTStack的<a href="https://github.com/bluekitchen/btstack">源码</a>，编译的时候遇到很多错误，iOS部分的工程结构本身就有很多问题，还有很多符号找不到。后来chekcout了v0.9分支，发现master的工程结构跟v0.9的完全不一样，但是两个分支里iOS的文件夹别无二致，缺少的符号在v0.9分支里都有，可能是长时间没有维护iOS版本的库了把，最终使用v0.9分支成功编译。其实也可以直接在Cidya里安装BTStack，然后将libBTStack.dylib从手机里拷出来。</p>

<p>接下来要实现RFCOMM通讯功能，坑爹的是，BTStack给出的demo中使用的是L2CAP协议，同时，BTstackManager类中只有对底层协议的封装，没有对RFCOMM/L2CAP等高层数据传输协议进行封装，留了接口，但是方法体是空的，只好自己动手了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">handlePacketWithType:</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="nv">packet_type</span> <span class="nf">forChannel:</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="nv">channel</span> <span class="nf">andData:</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="nv">packet</span> <span class="nf">withLen:</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">size</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// -- omitted --</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">kActivated</span>:
</span><span class='line'>            <span class="k">switch</span> <span class="p">(</span><span class="n">packet_type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">case</span> <span class="n">HCI_EVENT_PACKET</span>:
</span><span class='line'>                    <span class="k">switch</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
</span><span class='line'>                        <span class="k">case</span> <span class="n">BTSTACK_EVENT_STATE</span>:
</span><span class='line'>                            <span class="p">[</span><span class="n">self</span> <span class="n">activationHandleEvent</span><span class="o">:</span><span class="n">packet</span> <span class="n">withLen</span><span class="o">:</span><span class="n">size</span><span class="p">];</span>
</span><span class='line'>                            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">case</span> <span class="n">RFCOMM_EVENT_OPEN_CHANNEL_COMPLETE</span>:
</span><span class='line'>                            <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;RFCOMM channel open failed, status %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>                                <span class="c1">// TODO connection failed callback</span>
</span><span class='line'>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                                <span class="kt">uint16_t</span> <span class="n">rfcomm_channel_id</span> <span class="o">=</span> <span class="n">READ_BT_16</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
</span><span class='line'>                                <span class="kt">uint16_t</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">READ_BT_16</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
</span><span class='line'>                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;RFCOMM channel open succeeded. New RFCOMM Channel ID %u, max frame size %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rfcomm_channel_id</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>
</span><span class='line'>                                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">rfcommDelegate</span> <span class="n">rfcommConnectionCreatedAtAddress</span><span class="o">:</span><span class="s">&quot;&quot;</span> <span class="n">forChannel</span><span class="o">:</span><span class="n">channel</span> <span class="n">asID</span><span class="o">:</span><span class="n">rfcomm_channel_id</span><span class="p">];</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">case</span> <span class="n">HCI_EVENT_DISCONNECTION_COMPLETE</span>:
</span><span class='line'>                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Basebank connection closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                            <span class="kt">uint16_t</span> <span class="n">rfcomm_channel_id</span> <span class="o">=</span> <span class="n">READ_BT_16</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
</span><span class='line'>                            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">rfcommDelegate</span> <span class="n">rfcommConnectionClosedForConnectionID</span><span class="o">:</span><span class="n">rfcomm_channel_id</span><span class="p">];</span>
</span><span class='line'>                            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                        <span class="nl">default:</span>
</span><span class='line'>                            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="k">case</span> <span class="n">RFCOMM_DATA_PACKET</span>:
</span><span class='line'>                    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Received from 0x%02X %@&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="p">[</span><span class="n">NSData</span> <span class="n">dataWithBytes</span><span class="o">:</span><span class="n">packet</span> <span class="n">length</span><span class="o">:</span><span class="n">size</span><span class="p">]);</span>
</span><span class='line'>                    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">rfcommDelegate</span> <span class="n">rfcommDataReceivedForConnectionID</span><span class="o">:</span><span class="n">channel</span> <span class="n">withData</span><span class="o">:</span><span class="n">packet</span> <span class="n">ofLen</span><span class="o">:</span><span class="n">size</span><span class="p">];</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">[</span><span class="n">self</span> <span class="n">discoveryHandleEvent</span><span class="o">:</span><span class="n">packet</span> <span class="n">withLen</span><span class="o">:</span><span class="n">size</span><span class="p">];</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="nl">default:</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// -- omitted --</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">-</span><span class="p">(</span><span class="n">BTstackError</span><span class="p">)</span> <span class="n">createRFCOMMConnectionAtAddress</span><span class="o">:</span><span class="p">(</span><span class="kt">bd_addr_t</span><span class="o">*</span><span class="p">)</span> <span class="n">address</span> <span class="n">withChannel</span><span class="o">:</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">channel</span> <span class="n">authenticated</span><span class="o">:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="n">authentication</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">kActivated</span><span class="p">)</span> <span class="k">return</span> <span class="n">BTSTACK_NOT_ACTIVATED</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">kActivated</span><span class="p">)</span> <span class="k">return</span> <span class="n">BTSTACK_BUSY</span><span class="p">;</span>
</span><span class='line'>    <span class="n">bt_send_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcomm_create_channel</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">-</span><span class="p">(</span><span class="n">BTstackError</span><span class="p">)</span> <span class="nf">sendRFCOMMPacket:</span><span class="p">(</span><span class="n">NSData</span><span class="o">*</span><span class="p">)</span><span class="nv">packet</span> <span class="nf">ForConnectionId:</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="nv">connectionId</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">kActivated</span><span class="p">)</span> <span class="k">return</span> <span class="n">BTSTACK_NOT_ACTIVATED</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Send to 0x%02X %@&quot;</span><span class="p">,</span> <span class="n">connectionId</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
</span><span class='line'>    <span class="n">bt_send_rfcomm</span><span class="p">(</span><span class="n">connectionId</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)[</span><span class="n">packet</span> <span class="n">bytes</span><span class="p">],</span> <span class="p">[</span><span class="n">packet</span> <span class="n">length</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">-</span><span class="p">(</span><span class="n">BTstackError</span><span class="p">)</span> <span class="nf">closeRFCOMMConnectionWithID:</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">connectionID</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span><span class="n">kActivated</span><span class="p">)</span> <span class="k">return</span> <span class="n">BTSTACK_NOT_ACTIVATED</span><span class="p">;</span>
</span><span class='line'>    <span class="n">bt_send_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hci_disconnect</span><span class="p">,</span><span class="n">connectionID</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>RFCOMM部分的代码实现完毕，尝试发送纯文本数据，结果LEGO根本毫无反应o(╯□╰)o。仔细阅读了LeJOS蓝牙部分的源码，发现数据包的头部，被添加了两个字节(Big-endian)用于标识数据包的大小:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Send length of packet (Least and Most significant byte)</span>
</span><span class='line'>    <span class="c1">// * NOTE: Bluetooth only. </span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span><span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">((</span><span class="kt">byte</span><span class="o">)(</span><span class="n">data</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">8</span><span class="o">));</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这下就好办了，发送数据之前，先处理一下数据包，同样在头部插入两个字节的长度即可:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// Util.m</span>
</span><span class='line'><span class="k">+</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span> <span class="nf">btDataForNxtWithString:</span> <span class="p">(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">string</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSInteger</span> <span class="n">length</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">u_int8_t</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>    <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span><span class='line'>    <span class="n">NSData</span><span class="o">*</span> <span class="n">_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="n">dataWithBytes</span><span class="o">:</span><span class="n">data</span> <span class="n">length</span><span class="o">:</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Send Data: %@&quot;</span><span class="p">,</span> <span class="n">_data</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_data</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>深夜3点，测试一下RFCOMM通信</p>

<p><img src="/assets/2017/bluetooth.jpg" alt="bluetooth" /></p>

<p>真是一把辛酸泪。。。</p>

<p><img src="/assets/2017/cry.png" alt="cry" /></p>

<h3>扫描部分</h3>

<p>之前Android控制器的扫描部分存在两个遗留问题，一是无法自动采集魔方的颜色，二是对颜色的识别仍然存在不准的情况。这两个问题不解决，始终是心里的一个疙瘩。</p>

<p>如何自动采集魔方的颜色呢？如果能检测到魔方的位置，一切就好办了。那么问题转换成如何检测摄像头的画面中是否有魔方，以及魔方在画面中的位置。我先考虑了一种方案：</p>

<ul>
<li>检测画面中的直线，如果有其中8条直线能够组成一个九宫格的样式，则检测到魔方</li>
</ul>


<p>怎么检测直线呢？经过一番Google，找到了基于iOS开源图像处理框架GPUImage的一种算法。事实证明，我还是too young, too naive：</p>

<p><img src="/assets/2017/detect1.png" alt="detect1" /></p>

<p>不管如何调整检测参数，直线的数量都超乎我的想象，更何况，我根本想不出一种算法去判断他们是不是能组成九宫格的图案。。。</p>

<p>后来就到处扒图像识别相关的资料，发现了基于OpenCV的一个很有意思的<a href="https://github.com/opencv/opencv/blob/master/samples/cpp/squares.cpp">Demo</a>，可以识别图像中的正方形，新的识别方案就此诞生</p>

<ul>
<li>如果能从图像中检测到9个相互不覆盖的正方形，就可以近似认为检测到了魔方</li>
</ul>


<p><img src="/assets/2017/detect2.png" alt="detect2" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="kt">void</span> <span class="nf">findSquares</span><span class="p">(</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">image</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">squares</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">squares</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>    <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">contours</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// find contours and store them all as a list</span>
</span><span class='line'>    <span class="n">findContours</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">CV_RETR_LIST</span><span class="p">,</span> <span class="n">CV_CHAIN_APPROX_SIMPLE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="o">&gt;</span> <span class="n">approx</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// test each contour</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">contours</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// approximate contour with accuracy proportional</span>
</span><span class='line'>        <span class="c1">// to the contour perimeter</span>
</span><span class='line'>        <span class="n">approxPolyDP</span><span class="p">(</span><span class="n">Mat</span><span class="p">(</span><span class="n">contours</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">approx</span><span class="p">,</span> <span class="n">arcLength</span><span class="p">(</span><span class="n">Mat</span><span class="p">(</span><span class="n">contours</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">true</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// square contours should have 4 vertices after approximation</span>
</span><span class='line'>        <span class="c1">// relatively large area (to filter out noisy contours)</span>
</span><span class='line'>        <span class="c1">// and be convex.</span>
</span><span class='line'>        <span class="c1">// Note: absolute value of an area is used because</span>
</span><span class='line'>        <span class="c1">// area may be positive or negative - in accordance with the</span>
</span><span class='line'>        <span class="c1">// contour orientation</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span> <span class="n">approx</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>           <span class="n">fabs</span><span class="p">(</span><span class="n">contourArea</span><span class="p">(</span><span class="n">Mat</span><span class="p">(</span><span class="n">approx</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>           <span class="n">isContourConvex</span><span class="p">(</span><span class="n">Mat</span><span class="p">(</span><span class="n">approx</span><span class="p">))</span> <span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">double</span> <span class="n">maxCosine</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>                <span class="c1">// find the maximum cosine of the angle between joint edges</span>
</span><span class='line'>                <span class="kt">double</span> <span class="n">cosine</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">angle</span><span class="p">(</span><span class="n">approx</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="mi">4</span><span class="p">],</span> <span class="n">approx</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">approx</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]));</span>
</span><span class='line'>                <span class="n">maxCosine</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">maxCosine</span><span class="p">,</span> <span class="n">cosine</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="kt">double</span> <span class="n">lineLength1</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">approx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">approx</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>            <span class="kt">double</span> <span class="n">lineLength2</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">approx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">approx</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// if cosines of all angles are small and border length almost equals</span>
</span><span class='line'>            <span class="c1">// (all angles are ~90 degree) then write quandrange</span>
</span><span class='line'>            <span class="c1">// vertices to resultant sequence</span>
</span><span class='line'>            <span class="c1">// then filter out big squares such as the whole facelet of the cube</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span> <span class="n">maxCosine</span> <span class="o">&lt;</span> <span class="mf">0.1</span>
</span><span class='line'>               <span class="o">&amp;&amp;</span> <span class="n">fabs</span><span class="p">(</span><span class="n">lineLength1</span> <span class="o">-</span> <span class="n">lineLength2</span><span class="p">)</span> <span class="o">/</span> <span class="n">MAX</span><span class="p">(</span><span class="n">lineLength1</span><span class="p">,</span> <span class="n">lineLength2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span>
</span><span class='line'>               <span class="o">&amp;&amp;</span> <span class="n">lineLength1</span> <span class="o">/</span> <span class="n">image</span><span class="p">.</span><span class="n">cols</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="n">squares</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">squares</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">approx</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// make sure no overlap</span>
</span><span class='line'>                    <span class="k">for</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Point</span><span class="o">&gt;&gt;::</span><span class="n">iterator</span> <span class="n">s</span> <span class="o">=</span> <span class="n">squares</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">squares</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="kt">int</span> <span class="n">contains</span> <span class="o">=</span> <span class="n">squareContains</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">approx</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">contains</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span> <span class="c1">//s contains approx</span>
</span><span class='line'>                            <span class="n">squares</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>                            <span class="n">squares</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">approx</span><span class="p">);</span>
</span><span class='line'>                            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">contains</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// approx contains s</span>
</span><span class='line'>                            <span class="k">break</span><span class="p">;</span> <span class="c1">// discard this approx</span>
</span><span class='line'>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">squares</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="n">squares</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">approx</span><span class="p">);</span>
</span><span class='line'>                                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// printf(&quot;found %lu squares\n&quot;, squares.size());</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">squares</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">squares</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// sort squares to sequence</span>
</span><span class='line'>        <span class="c1">// 0 1 2</span>
</span><span class='line'>        <span class="c1">// 3 4 5</span>
</span><span class='line'>        <span class="c1">// 6 7 8</span>
</span><span class='line'>        <span class="n">sort</span><span class="p">(</span><span class="n">squares</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">squares</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">compareTwoPointsWithY</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sort</span><span class="p">(</span><span class="n">squares</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">squares</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">compareTwoPointsWithX</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sort</span><span class="p">(</span><span class="n">squares</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">squares</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">compareTwoPointsWithX</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sort</span><span class="p">(</span><span class="n">squares</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">squares</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="n">compareTwoPointsWithX</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>是不是很机智！当然，这个算法也会有傻逼的时候：</p>

<p><img src="/assets/2017/detect3.png" alt="detect3" /></p>

<p>解决类似的问题需要再检测一下每个正方形之间的间距。不过，如果放在魔方机器人的底座上进行扫描，周围应该没有什么干扰项，多增加一部分计算的代码反而会影响画面的刷新率，也就无所谓了。</p>

<p>扫描完魔方的54个块之后，就需要对每个块的颜色进行识别分组，之前的算法是计算每个颜色与6个基准色(也就是每个面中心块的颜色)的色差，仍然会存在不准的情况，这次我扫描记录了大量颜色数据，从中分析出以下特征：</p>

<ul>
<li>白色块的RGB分量之和大于任何其他色块</li>
<li>绿色块的G分量与R/B分量的差值，是所有色块中最大的</li>
<li>除去白色与绿色，剩下的色块，B分量与R/G分量的差值，从大到小依次是

<ul>
<li>蓝色 > 红色 > 橙色 > 黄色</li>
</ul>
</li>
</ul>


<p>其实这样的比较方式，在昏暗的光线下，红色与橙色仍然非常相近，但根据测试，错误率大概不到3%，还算可以接受。因此，只需要对54个颜色进行多次不同维度的排序，就可以识别出正确的颜色</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="nf">detectColors</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">sort</span><span class="p">(</span><span class="n">colorNodes</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">colorNodes</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">sortForWhite</span><span class="p">);</span> <span class="c1">// W X X X X X</span>
</span><span class='line'>    <span class="n">sort</span><span class="p">(</span><span class="n">colorNodes</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">,</span> <span class="n">colorNodes</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">sortForGreen</span><span class="p">);</span> <span class="c1">// W G X X X X</span>
</span><span class='line'>    <span class="n">sort</span><span class="p">(</span><span class="n">colorNodes</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">18</span> <span class="p">,</span> <span class="n">colorNodes</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">sortForBlue</span><span class="p">);</span> <span class="c1">// W G B R O Y</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">colors</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;WWWWWWWWWGGGGGGGGGBBBBBBBBBRRRRRRRRROOOOOOOOOYYYYYYYYY&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">colorNodes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">colorNodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">sort</span><span class="p">(</span><span class="n">colorNodes</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">colorNodes</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">restoreInputSequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">map</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">colorMap</span><span class="p">;</span>
</span><span class='line'>    <span class="n">colorMap</span><span class="p">[</span><span class="n">colorNodes</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;U&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">colorMap</span><span class="p">[</span><span class="n">colorNodes</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;B&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">colorMap</span><span class="p">[</span><span class="n">colorNodes</span><span class="p">[</span><span class="mi">22</span><span class="p">].</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;D&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">colorMap</span><span class="p">[</span><span class="n">colorNodes</span><span class="p">[</span><span class="mi">31</span><span class="p">].</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">colorMap</span><span class="p">[</span><span class="n">colorNodes</span><span class="p">[</span><span class="mi">40</span><span class="p">].</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">colorMap</span><span class="p">[</span><span class="n">colorNodes</span><span class="p">[</span><span class="mi">49</span><span class="p">].</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;L&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">convertTable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">38</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">35</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">26</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">47</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">char</span> <span class="n">state</span><span class="p">[</span><span class="mi">55</span><span class="p">];</span>
</span><span class='line'>    <span class="n">state</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;============================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">colorNodes</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">colorMap</span><span class="p">[</span><span class="n">colorNodes</span><span class="p">[</span><span class="n">convertTable</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">color</span><span class="p">];</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;color %d: %c %f, %f, %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">colorNodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">color</span><span class="p">,</span> <span class="n">colorNodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scalar</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">colorNodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scalar</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">colorNodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scalar</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span><span class="n">initWithCString</span><span class="o">:</span><span class="n">state</span> <span class="n">encoding</span><span class="o">:</span> <span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>PS: <code>convertTable</code>是为了将输出的颜色顺序转换为还原算法所需的顺序。</p>

<p>PPS: 输出的颜色是用该颜色所属的面表示的。</p>

<h3>算法部分</h3>

<p>Two-Phase算法，也有pure C的版本，但是这个算法内存占用奇高，且计算出的还原步骤一般都要22步，甚至更多，如果要计算20步以内(<a href="http://www.cube20.org/">上帝之数是20</a>，也就是说任意魔方都可以用不超过20步进行还原)的解法，要花上数分钟的时间。因此我又花了大量的时间寻找性能更好的算法，最终找到两个：</p>

<ul>
<li>optimal Rubik&rsquo;s cube solver，需要80M内存，但实际测试，有大约50%的情况，一直运行，但始终给不出答案(超过5分钟)，不知道是不是算法中存在bug</li>
<li>Dik T. Winter 的算法，内存占用大概只有10M+，计算任意魔方的解法，几乎都可以瞬间给出20步以内的结果</li>
</ul>


<p>很显然，这个没有名字的算法正合我意。经过一番调整和优化，这个算法顺利地在iOS上跑了起来。</p>

<p>将这三部分整合起来，就是文章最开始的那个视频的样子，历经千辛万苦，终于实现了最初设计的那套方案。</p>

<p><img src="/assets/2017/xuebi.jpg" alt="xuebi" /></p>

<h2>0x05 膜拜一下大神们</h2>

<ol>
<li><p><code>3.25s</code>的世界纪录保持者Cube Stormer 3</p>

<p><iframe width="100%" height="450" src="https://www.youtube.com/embed/X0pFZG7j5cE" frameborder="0" allowfullscreen></iframe></p>

<p>这个是使用Lego NXT的升级版 EV3 拼成的魔方机器人，猜猜用了多少零件？</p></li>
<li><p>国内LEGO大神，动力老男孩做的<a href="http://www.diy-robots.com/?page_id=46">萝卜头</a></p></li>
<li><p>开源魔方机器人，<a href="http://mindcuber.com/index.html">MindCuber</a>，作者正是Cube Stormer 3的作者之一<code>David Gilday</code></p></li>
</ol>

</div>


<div class="meta">
	<div class="date">








  


<time datetime="2017-02-18T20:00:00+00:00" pubdate data-updated="true">2017-02-18</time></div>
    

<div class="tags">

	<a class='category' href='/blog/categories/cube/'>cube</a>, <a class='category' href='/blog/categories/lego/'>lego</a>, <a class='category' href='/blog/categories/nxt/'>nxt</a>

</div>


    
        
            
    <div class="comments"><a href="#disqus_thread">Comments</a></div>
            
        
    
</div>
</article>

	<div class="share">
	<div class="license">
		<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
			<img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png">
		</a>
		<br>
		This work is licensed under a 
		<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
			Creative Commons Attribution-NonCommercial 4.0 International License
		</a>
		.
	</div>
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2019

    xelz

</footer>
	<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'xelz';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://xelz.info/blog/2017/02/18/lego-cube-solver/';
        var disqus_url = 'http://xelz.info/blog/2017/02/18/lego-cube-solver/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-41665464-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>




</body>
</html>